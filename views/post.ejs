<%- include("partials/start", { title: post.title, containerClass: "container full" }) %>

<script>
  document.body.dataset.postId = "<%= post.id %>";
</script>

<section class="postHeader cardAnim">
  <div class="crumbs">
    <a href="/">Home</a>
    <span class="dot">•</span>
    <a href="/c/<%= encodeURIComponent(post.category_key) %>"><%= post.category_name %></a>
  </div>

  <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
    <h2 style="margin:0;"><%= post.title %></h2>

    <% if (canAdmin) { %>
      <% if (Number(post.is_closed) === 1) { %>
        <form method="POST" action="/admin/posts/<%= post.id %>/open" style="margin:0;">
          <button class="btn ghost" type="submit">Re-open</button>
        </form>
      <% } else { %>
        <form method="POST" action="/admin/posts/<%= post.id %>/close" style="margin:0;">
          <button class="btn" type="submit">Close post</button>
        </form>
      <% } %>
    <% } %>
  </div>

  <div class="authorLine">
    <span class="muted">@<%= post.username %></span>
    <span class="dot">•</span>
    <span class="muted"><%= new Date(post.created_at * 1000).toLocaleString() %></span>

    <% if (Number(post.is_closed) === 1) { %>
      <span class="dot">•</span>
      <span class="badge role admin">Closed</span>
    <% } %>

    <span class="dot">•</span>
    <span class="badges">
      <% if (post.badges && post.badges.length) { %>
        <% post.badges.slice(0,3).forEach(b => { %>
          <span class="badge role <%= b.style %>"><%= b.label %></span>
        <% }) %>
      <% } else { %>
        <span class="badge role neutral">Member</span>
      <% } %>
    </span>
  </div>

  <article class="contentBox"><%= post.body %></article>
</section>

<section id="replies" class="replies">
  <h3 class="cardAnim">Replies</h3>

  <div id="liveReplies">
    <% if (!replies || replies.length === 0) { %>
      <div class="empty cardAnim">No replies yet.</div>
    <% } %>

    <% (replies || []).forEach(r => { %>
      <div class="reply cardAnim">
        <div class="replyHead">
          <span class="muted">@<%= r.username %></span>
          <span class="dot">•</span>
          <span class="muted"><%= new Date(r.created_at * 1000).toLocaleString() %></span>
          <span class="dot">•</span>
          <span class="badges">
            <% if (r.badges && r.badges.length) { %>
              <% r.badges.slice(0,3).forEach(b => { %>
                <span class="badge role <%= b.style %>"><%= b.label %></span>
              <% }) %>
            <% } else { %>
              <span class="badge role neutral">Member</span>
            <% } %>
          </span>
        </div>
        <div class="contentBox"><%= r.body %></div>
      </div>
    <% }) %>
  </div>

  <% if (me) { %>
    <% if (Number(post.is_closed) === 1) { %>
      <div class="empty cardAnim">This post is closed. Replies are disabled.</div>
    <% } else { %>
      <form class="form cardAnim" method="POST" action="/reply/<%= post.id %>">
        <label>Your reply</label>
        <textarea name="body" rows="5" placeholder="Write your reply..." required></textarea>
        <button class="btn" type="submit">Reply</button>
      </form>
    <% } %>
  <% } else { %>
    <a class="btn big cardAnim" href="/auth/discord">Login to reply</a>
  <% } %>
</section>

<%- include("partials/end") %>
